### 정의

연관 관계가 있을 때 발생할 수 있는 문제로, 연관 관계가 설정된 엔티티를 조회 시 엔티티와 연관된 데이터 갯수(N)만큼 추가로 조회 쿼리가 발생하는 문제이다.

1+N 문제라고 하는 것이 더 직관적이다.

### 발생 상황

JPQL 을 사용해서 조회할 시에 발생함

참고) JPQL 동작 과정

1. JPQL 을 호출하면 데이터베이스에 우선적으로 조회한다.
2. 조회한 값을 영속성 컨텍스트에 저장한다.
3. 영속성 컨텍스트에 저장할 때 이미 존재하는 데이터가 있다면 데이터를 버린다.

### 발생 원인

JPA 가 JPQL 을 분석해서 SQL 을 생성할 때는 글로벌 패치 전략을 무시하고 데이터베이스에 SQL 을 실행해서 연관된 엔티티들을 바인딩하지 않기 때문이다.(연관된 엔티티들은 지연 로딩으로 프록시가 들어감)

즉, 하위 엔티티들을 첫 쿼리 실행 시 한 번에 가져오지 않고, 지연 로딩으로 프록시가 들어온 상태로 최초 바인딩을 한다. 최초 바인딩 된 후에 JPA 에서 즉시 로딩이라면 바로 N 개의 쿼리를 발생시키고, 지연 로딩이라면 연관된 엔티티를 사용할 때 N 개의 조회 쿼리가 다시 나가게 된다.

### 해결 방법

- Fetch Join
    - Fetch Join을 사용하면 지연 로딩으로 프록시로 들어오던 것을 join으로 한 번에 땡겨올 수 있다.
- Batch Size
    - Batch Size는 N+1 문제가 발생하던 것 처럼 최초 바인딩 시에는 연관 엔티티를 프록시로 가져온다. 다만, 연관 엔티티를 가져올 때 한번에 가져오는 수를 지정하여 쿼리 수를 줄일 수 있다. 이때 in 쿼리로 Batch size 개수만큼 가져온다.
- @EntityGraph
    - 연관된 엔티티를 다 가져오도록 설정할 수 있다.
