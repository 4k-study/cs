## JVM 의 동작 과정

1. 자바 프로그램을 실행하면 JVM 이 OS 로부터 메모리를 할당받습니다.
2. 자바 컴파일러가 소스 코드를 바이트 코드(.class) 로 컴파일합니다.
3. Class loader 가 필요한 클래스들을 로딩 및 링크하여 Runtime data area 에 올립니다.
4. Runtime data area 에 올라간 바이트 코드들은 Execution engine 에 의해 해석됩니다.
5. 이 과정에서 Execution engine 에 의해 가비지 컬렉터 동작과 스레드 동기화가 이루어집니다.

## JVM 구조

- Class loader
- Runtime data area
    - 메소드 영역
    - 힙 영역
    - PC Register
    - 스택 영역
    - 네이티브 메소드
- Execution engine
    - 인터프리터
    - JIT 컴파일러
    - 가비지 콜렉터
- 네이티브 메소드 인터페이스
- 네이티브 메소드 라이브러리

### Class loader

JVM 내로 바이트 코드를 로드하고 링크하여 Runtime data area 에 배치하는 역할을 합니다.

클래스를  메모리에 올리는 로딩은 한번에 메모리에 올리지 않고, 어플리케이션에서 필요한 경우 동적으로 올립니다.

클래스 파일의 로딩은 Loading → Linking → Initialization 의 순서로 이루어집니다.

1. Loading : 클래스 파일을 가져와서 JVM의 메모리에 로드합니다.
2. Linking : 클래스 파일을 사용하기 위해 검증하는 과정입니다.
    1. Verifying : 읽은 클래스가 JVM 명세에 명시된 대로 구성되어 있는지 검사합니다.
    2. Preparing : 클래스가 필요로 하는 메모리를 할당합니다.
    3. Resolving : 클래스의 상수 풀 내 모든 심볼릭 레퍼런스를 다이렉트 레퍼런스로 변경합니다.
3. Initialization : 클래스 변수들을 적절한 값으로 초기화합니다. ( static 필드들을 설정된 값으로 초기화 등 )

### Runtime data area

JVM 의 메모리 영역입니다. 자바 어플리케이션이 실행될 때 사용되는 데이터들을 올리는 영역입니다.

크게 메소드, 힙, 스택, PC Register, 네이티브 메서드 영역으로 나눌 수 있습니다.

메소드, 힙 영역은 모든 스레드가 공유합니다.

나머지 스택, PC Resister, 네이티브 메서드 영역은 각 스레드마다 생성되는 고유의 영역입니다.

- 메서드 영역
    - JVM 이 시작될 때 생성되는 공간입니다. 바이트 코드를 메모리에 처음 올릴 때 초기화되는 대상을 저장하기 위한 공간입니다.
    - JVM 이 동작하고 클래스 로드 시부터 프로그램 종료시까지 유지됩니다.
    - Static 영역이라고도 불립니다.
    - static 필드와 클래스 구조만을 가지고 있습니다.
- 힙 영역
    - 동적으로 할당하는 데이터를 저장하는 공간입니다.
    - 객체가 더 이상 참조되지 않거나 null  선언 시 GC 에 의해 회수됩니다.
- 스택 영역
    - 임시적으로 사용되는 데이터들을 저장하는 영역입니다.
    - 원시 타입은 스택 영역에 직접 값을 가지고, 참조 타입은 참조하는 주소를 가집니다.
- PC Register
    - 스레드가 시작될 때 생성됩니다.
    - 현재 수행 중인 JVM 명령어의 주소를 저장합니다.
- 네이티브 메서드 스택
    - 기계어로 작성된 프로그램을 실행시키는 영역입니다. 혹은 C, C++, 어셈블리 같은 네이티브 코드를 싱행하기 위한 영역이기도 합니다.
    - JIT 컴파일러로 변환된 네이티브 코드가 여기서 실행됩니다.
    

### Execution engine

Execution engine 은 Runtime data area 에 올려진 바이트 코드를 명령어 단위로 읽어서 실행하는 역할을 합니다.

자바의 바이트 코드는 기계가 바로 읽을 수 있는 언어가 아니라 가상 머신이 읽을 수 있는 언어입니다. Execution engine 이 이 바이트 코드를 읽어서 기계가 읽을 수 있도록 변경해줍니다.

이 때, 인터프리터와 JIT 컴파일러를 함께 사용하는데 한 번 알아보도록 하겠습니다.

- 인터프리터
    - 바이트 코드 명령어를 하나씩 읽어서 해석하고 바로 실행합니다.
    - 기본적으로 바이트 코드는 인터프리터 방식으로 해석됩니다. 같은 메서드인 경우에도 계속 해석이 되어야하는 단점이 있습니다.
- JIT 컴파일러
    - 위에서 언급한 인터프리터의 단점을 보완하기 위해 나왔습니다.
    - 바이트 코드 전체를 컴파일하여 이후에는 그 메서드를 인터프리팅하지 않고 캐싱하여 사용합니다.
    - 매번 바이트 코드를 컴파일하는 것도 비용이 필요하므로 인터프리터 방식을 기본으로 사용하다가 일정 기준이 넘어가면 JIT 컴파일러를 사용하는 방식으로 진행합니다.
- 가비지 컬렉터
    - JVM 은 GC 를 이용하여 힙 메모리에서 사용하지 않는 메모리를 자동으로 회수합니다.
    - 객체가 참조되고 있지 않은 상태일 때 가비지로 판단하고 회수합니다.

### 네이티브 메서드 인터페이스

다른 언어로 만들어진 어플리케이션과 상호 작용할 수 있도록 인터페이스를 제공합니다.

### 네이티브 메서드 라이브러리

C, C++ 로 작성된 라이브러리입니다.
